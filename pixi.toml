[workspace]
name = "wv-forge"
requires-pixi = ">=0.59.0"
description = "The entry point to wv-forge"
version = "0.1.0"
# license = "BSD-3-Clause"
# license-file = "LICENSE.txt"
authors = ["Logan Lang <lllangWV@gmail.com"]
# Use conda-forge for dependencies. Add "wv-forge" when the channel exists on Anaconda.org
channels = ["https://prefix.dev/wv-forge", "conda-forge"]
platforms = [
    "linux-64", "linux-aarch64", "osx-64", "osx-arm64", "win-64"
    # TODO: add here and below in `feature.win` when possible
    # "win-arm64"
]


[tasks]
upload = "python scripts/upload_to_prefix.py"
upload-all = "python scripts/upload_to_prefix.py --all"
upload-force = "python scripts/upload_to_prefix.py --all --force"
build-cloudcompare = "rattler-build build -r src/cloudcompare/recipe.yaml -c conda-forge"



[feature.python.dependencies]
python = "3.12.*"


[feature.build.activation.env]
C="sccache $C"
CXX="sccache $CXX"
[feature.build.dependencies]
conda = ">=25.9.0"
conda-libmamba-solver = ">=24.9.0"
conda-build = ">=25.3.1"
conda-index = ">=0.3.0"
conda-forge-ci-setup = ">=4.9.3,<5.0"
conda-forge-pinning = "*"
frozendict = "*"
networkx = "2.4.*"
rattler-build-conda-compat = ">=1.2.0,<2.0.0a0"

[feature.build.tasks.build]
description = "Build packages in Docker with rattler-build (default: --all)"
cmd = "python build_locally.py {{ flags }}"
args = [{ arg = "flags", default = "--all" }]

[feature.build.tasks.build-noarch]
description = "Build only noarch packages in Docker"
depends-on = [{ task = "build", args = ["--noarch-only"] }]

[feature.build.tasks.build-variant]
description = "Build only CUDA variant packages in Docker"
depends-on = [{ task = "build", args = ["--variant-only"] }]

[feature.linux]
# The linux feature runs on every platform that can run Docker.
platforms = ["linux-64", "linux-aarch64", "osx-64", "osx-arm64", "win-64"]
[feature.linux.tasks.build-linux]
description = "Build packages in Docker with rattler-build (default: --all)"
cmd = "python build_locally.py {{ flags }}"
args = [{ arg = "flags", default = "--all" }]

[feature.osx]
# The osx env will run directly on the machine.
platforms = ["osx-64", "osx-arm64"]
[feature.osx.tasks.build-osx]
description = "build directly on a MacOS host machine"
cmd = "python build_locally.py --filter 'osx*'"
[feature.osx.tasks.build-osx.env]
CONDA_BLD_PATH = "$PIXI_PROJECT_ROOT/build_artifacts"
MINIFORGE_HOME = "$CONDA_PREFIX"
OSX_SDK_DIR = "$PIXI_PROJECT_ROOT/.pixi/macOS-SDKs"

[feature.win]
# The windows env will run directly on the machine.
platforms = ["win-64"]
[feature.win.tasks.build-win]
description = "build directly on a Windows host machine"
cmd = "python build_locally.py --filter 'win*'"
[feature.win.tasks.build-win.env]
CONDA_BLD_PATH = "$PIXI_PROJECT_ROOT/build_artifacts"
MINIFORGE_HOME = "$CONDA_PREFIX"

[feature.grayskull.dependencies]
grayskull = ">=2.7.3"
conda-recipe-manager = ">=0.8.0"
[feature.grayskull.tasks.pypi]
description = "generate a v1 (rattler-build) recipe for a PyPI package name with `grayskull`"
cmd = "cd recipes && grayskull pypi --strict-conda-forge --use-v1-format"
[feature.grayskull.tasks.cran]
description = "generate a v1 (rattler-build) recipe for a CRAN package name with `grayskull`"
cmd = "cd recipes && grayskull cran --strict-conda-forge --use-v1-format"
[feature.grayskull.tasks.pypi-v0]
description = "generate a v0 (conda-build) recipe for a PyPI package name with `grayskull`"
cmd = "cd recipes && grayskull pypi --strict-conda-forge"
[feature.grayskull.tasks.cran-v0]
description = "generate a v0 (conda-build) recipe for a CRAN package name with `grayskull`"
cmd = "cd recipes && grayskull cran --strict-conda-forge"

[feature.conda-smithy.dependencies]
conda-smithy = ">=3.44.6,<4"
[feature.conda-smithy.tasks.lint]
description = "validate all recipes with `conda-smithy`"
cmd = "conda-smithy recipe-lint --conda-forge recipes/*"

[feature.shellcheck]
# merge this with `conda-smithy` when available for `linux-ppc64le`
platforms = ["linux-64", "linux-aarch64", "osx-64", "osx-arm64", "win-64"]
dependencies.shellcheck = ">=0.10.0"

[environments]
# cumm = { features = ["cumm"], solve-group = "cumm" }
# sam3d = { features = ["sam3d"], solve-group = "sam3d" }
# linux only needs Python to run build-locally.py. Everything else happens in Docker.
linux = ["linux", "python"]
# osx and win do run natively on the machine, so we need the build deps too
osx = ["osx", "python", "build"]
win = ["win", "python", "build"]
build = ["python", "build"]
grayskull = ["python", "grayskull"]
conda-smithy = ["python", "conda-smithy", "shellcheck"]





# [feature.cumm]
# platforms = ["linux-64"]
# system-requirements = { cuda = "12.6" }

# [feature.cumm.dependencies]
# cumm = "*"
# cuda-version = "12.6.*"
# spconv = "*"
# pytorch3d = "*"
# sam3d-objects = "*"
# moge = "*"
# pccm = "*"
# pointcept = "*"


# [feature.sam3d]
# platforms = ["linux-64"]
# system-requirements = { cuda = "12.6" }

# [feature.sam3d.dependencies]
# python = "==3.12.12"
# cumm = "*"
# cuda-version = "12.6.*"
# spconv = "*"
# pytorch3d = {version = "*",channel = "https://prefix.dev/wv-forge"}
# sam3d-objects = "*"
# moge = "*"
# pccm = "*"
# gsplat = "*"
# kaolin = "*"
# # open3d = "*"
# flash-attn = "*"
# xatlas-python = "*"

# [feature.sam3d.pypi-dependencies]
# open3d = "*"
